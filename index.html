<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pricebook (Markdown-backed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    header { position:sticky; top:0; background:#111; color:#fff; padding:12px 16px; z-index:10; }
    main { padding: 16px; display:grid; gap:16px; grid-template-columns: 1fr; }
    .bar { font-size:12px; opacity:0.85; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; background:#fff; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    h2, h3 { margin:8px 0; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:6px 8px; text-align:left; }
    th { background:#fafafa; position:sticky; top:0; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0; }
    button { cursor:pointer; border:1px solid #ccc; background:#f7f7f7; padding:6px 10px; border-radius:8px; }
    .tag { font-size:12px; padding:2px 6px; border-radius:6px; background:#eef; border:1px solid #ccd; }
    .tiny { font-size:12px; opacity:.8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .sticky-actions { position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,255,255,0), #fff 40%); padding:10px 0 0; }
    textarea { width:100%; min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <header>
    <div><strong>Pricebook</strong> — Markdown → JSON loader</div>
    <div class="bar" id="banner">Loading…</div>
  </header>
  <main>
    <section class="card">
      <h2>Sections</h2>
      <div class="controls">
        <button id="refreshBtn" title="Reload markdown files">Reload</button>
        <button id="exportJsonBtn" title="Download compiled JSON">Export JSON</button>
        <span class="tag" id="lastRefreshedTag">last_refreshed: –</span>
      </div>
      <div class="tiny">Add or edit files in <span class="mono">/pricebook-md/</span>; changes appear on reload.</div>
    </section>

    <section class="grid" id="sectionsGrid"></section>

    <section class="card sticky-actions">
      <h3>API Cheatsheet</h3>
      <div class="tiny mono">window.Pricebook.getItemsByCode("CBLR3453")</div>
      <div class="tiny mono">window.Pricebook.matchFlueBrand("Worcester")</div>
      <div class="tiny mono">window.Pricebook.data // compiled JSON</div>
      <div class="controls">
        <button id="copyApiBtn">Copy API Example</button>
      </div>
      <textarea id="apiBox" readonly></textarea>
    </section>
  </main>

  <script type="module">
    import { PricebookLoader } from "./js/pricebook-loader.js";

    const banner = document.getElementById('banner');
    const grid = document.getElementById('sectionsGrid');
    const lastTag = document.getElementById('lastRefreshedTag');
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportJsonBtn');
    const apiBox = document.getElementById('apiBox');
    const copyApiBtn = document.getElementById('copyApiBtn');

    const manifest = [
      // Core
      "pricebook-md/core-packs.md",
      // Boilers
      "pricebook-md/boilers/regular-ng.md",
      "pricebook-md/boilers/combi-ng.md",
      "pricebook-md/boilers/combi-lpg.md",
      // Flues
      "pricebook-md/flues/worcester.md",
      // Controls
      "pricebook-md/controls/wiring-packs.md",
      // Condensate
      "pricebook-md/condensate.md"
    ];

    const loader = new PricebookLoader({ manifest });

    async function render() {
      banner.textContent = "Loading markdown and compiling…";
      await loader.loadAll();
      banner.textContent = `Loaded ${loader.data.sections.length} sections, ${loader.data.items.length} items.`;
      lastTag.textContent = "last_refreshed: " + (loader.data.meta.last_refreshed || "–");

      grid.innerHTML = "";
      for (const sec of loader.data.sections) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${sec.title || sec.id}</h3>
          <div class="tiny mono">${sec.id}</div>
          ${sec.notes ? `<div class="tiny">${sec.notes}</div>` : ""}
          <div class="tiny">Items: ${sec.rows.length}</div>
          <div style="overflow:auto; max-height:340px; margin-top:8px;">
            ${tableHtml(sec.headers, sec.rows)}
          </div>
        `;
        grid.appendChild(card);
      }

      apiBox.value =
`// Example:
const ri12 = window.Pricebook.getItemsByCode("CBLR3453");
const worcesterFlues = window.Pricebook.matchFlueBrand("Worcester");
console.log({ ri12, worcesterFlues, all: window.Pricebook.data });`;
      // Expose API
      window.Pricebook = {
        data: loader.data,
        getItemsByCode: (code) => loader.data.items.filter(x => (x.Code||x.code) === code),
        matchFlueBrand: (brand) => loader.data.items.filter(x => (x.brand||"").toLowerCase() === brand.toLowerCase()),
      };
    }

    function tableHtml(headers, rows) {
      const h = headers.map(h => `<th>${escapeHtml(h)}</th>`).join("");
      const r = rows.map(row => {
        const tds = headers.map(h => `<td>${escapeHtml(row[h] ?? "")}</td>`).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      return `<table><thead><tr>${h}</tr></thead><tbody>${r}</tbody></table>`;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    refreshBtn.addEventListener('click', render);
    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(loader.data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'pricebook-compiled.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    copyApiBtn.addEventListener('click', async () => {
      apiBox.select(); document.execCommand('copy');
      copyApiBtn.textContent = "Copied!"; setTimeout(()=> copyApiBtn.textContent="Copy API Example", 1200);
    });

    render();
  </script>
</body>
</html>
