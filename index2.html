<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Testbed Quote • Core + Add to Job</title>
<style>
  :root{--bg:#0e1118;--fg:#eaf0ff;--mut:#9aa6bf;--card:#121728;--edge:#20273a;--chip:#182238;--accent:#5b7cff;--ok:#2dd4bf;--bad:#ff6b6b;--radius:14px}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;z-index:20;display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--edge);background:#0e1118cc;backdrop-filter:blur(6px)}
  header h1{font-size:16px;margin:0;font-weight:700}
  .spacer{flex:1}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border:1px solid var(--edge);border-radius:999px;background:var(--chip);cursor:pointer}
  .tab[aria-selected="true"]{outline:2px solid var(--accent)}
  main{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .panel{border:1px solid var(--edge);border-radius:var(--radius);background:var(--card)}
  .panel h2{margin:0;padding:12px;border-bottom:1px solid var(--edge);font-size:15px;background:#131a2b;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)}
  .content{padding:12px}
  .row{display:grid;gap:16px}
  @media (min-width:980px){.row{grid-template-columns:1.1fr .9fr}}
  .treeStrip{display:flex;gap:10px;overflow-x:auto;padding:6px;scrollbar-width:thin}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--edge);white-space:nowrap;cursor:pointer}
  .chip small{opacity:.7;font-size:12px}
  .crumbs{display:flex;gap:6px;flex-wrap:wrap}
  .crumb{background:#162036;border:1px dashed var(--edge);padding:6px 10px;border-radius:999px;font-size:12px}
  .muted{color:var(--mut)}
  textarea{width:100%;min-height:140px;background:#0f1425;color:var(--fg);border:1px solid var(--edge);border-radius:10px;padding:10px}
  button{background:#1a2236;color:var(--fg);border:1px solid var(--edge);border-radius:10px;padding:10px 12px;cursor:pointer}
  button:hover{border-color:#2d3753}
  .grid{display:grid;gap:12px}
  .tiles{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .tile{border:1px solid var(--edge);background:#131a2a;border-radius:12px;padding:16px;display:grid;gap:8px;cursor:pointer}
  .tile h3{margin:0;font-size:15px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--edge);font-size:12px;color:var(--mut)}
  .jobList{display:grid;gap:10px}
  .jobItem{border:1px solid var(--edge);border-radius:12px;padding:10px;background:#101628;display:grid;gap:6px}
  .jobHead{display:flex;gap:8px;align-items:center}
  .qty{width:64px;background:#0f1425;border:1px solid var(--edge);border-radius:8px;color:var(--fg);padding:6px}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  /* Modal */
  .modal{position:fixed;inset:0;background:#0b0f18dd;backdrop-filter:blur(4px);display:none;z-index:50}
  .modal.is-open{display:flex;align-items:center;justify-content:center;padding:16px}
  .sheet{width:min(900px,100%);max-height:90vh;overflow:auto;border:1px solid var(--edge);border-radius:16px;background:var(--card)}
  .sheet header{position:sticky;top:0;display:flex;gap:10px;align-items:center;padding:12px;background:#131a2b;border-bottom:1px solid var(--edge)}
  .sheet h3{margin:0;font-size:15px}
  .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .treeCols{display:grid;gap:12px;grid-template-columns:1fr}
  @media (min-width:860px){.treeCols{grid-template-columns:1fr 1fr}}
  .box{border:1px solid var(--edge);border-radius:12px;padding:10px;background:#0f1425}
  .leaf{display:flex;align-items:center;gap:8px;padding:6px;border:1px dashed #24304b;border-radius:10px}
  .leaf input{transform:scale(1.1)}
  .help{font-size:12px;color:var(--mut)}
</style>
</head>
<body>
<header>
  <h1>Testbed Quote</h1>
  <div class="spacer"></div>
  <nav class="tabs" role="tablist" aria-label="Pages">
    <button class="tab" id="tab-core" role="tab" aria-controls="page-core" aria-selected="true">1) Core</button>
    <button class="tab" id="tab-add" role="tab" aria-controls="page-add" aria-selected="false">2) Add to job</button>
  </nav>
</header>

<main>
  <section id="page-core" role="tabpanel" aria-labelledby="tab-core">
    <div class="row">
      <section class="panel">
        <h2>Core grove (must complete)</h2>
        <div class="content grid">
          <div class="help">Work left ➜ right. Each tap advances a level. Reach a leaf for every core branch.</div>
          <div id="coreBlocks" class="grid"></div>
          <div class="help"><span id="coreStatus" class="bad">Incomplete</span></div>
        </div>
      </section>
      <section class="panel">
        <h2>Output (live)</h2>
        <div class="content grid">
          <label>Semicolon text</label>
          <textarea id="outText" readonly></textarea>
          <label>JSON</label>
          <textarea id="outJson" readonly></textarea>
          <div class="flex">
            <button id="copyText">Copy text</button>
            <button id="copyJson">Copy JSON</button>
            <button id="resetCore">Reset core</button>
          </div>
        </div>
      </section>
    </div>
  </section>

  <section id="page-add" role="tabpanel" aria-labelledby="tab-add" hidden>
    <div class="row">
      <section class="panel">
        <h2>Add to job</h2>
        <div class="content grid">
          <div class="help">Tap a tile ➜ select multiple branches/leaves ➜ <b>Add to job</b>. Repeat as needed (multiples allowed).</div>
          <div class="tiles" id="tiles"></div>
          <div class="panel">
            <h2>Job list</h2>
            <div class="content">
              <div class="jobList" id="jobList"></div>
            </div>
          </div>
        </div>
      </section>
      <section class="panel">
        <h2>Output (live)</h2>
        <div class="content grid">
          <label>Semicolon text</label>
          <textarea id="outText2" readonly></textarea>
          <label>JSON</label>
          <textarea id="outJson2" readonly></textarea>
          <div class="flex">
            <button id="copyText2">Copy text</button>
            <button id="copyJson2">Copy JSON</button>
            <button id="clearJob">Clear job list</button>
          </div>
        </div>
      </section>
    </div>
  </section>
</main>

<!-- Modal for multi-select picker -->
<div class="modal" id="pickerModal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
    <header>
      <h3 id="pickerTitle">Select items</h3>
      <div class="spacer"></div>
      <button id="closePicker">Close</button>
    </header>
    <div class="content grid">
      <div class="treeCols">
        <div class="box">
          <div class="help">Tap through levels to reveal leaves. Tick any number of leaves.</div>
          <div class="treeStrip" id="pickLevel"></div>
          <div class="grid" id="leafList"></div>
        </div>
        <div class="box">
          <div class="help">Selected (you can adjust quantities before adding):</div>
          <div id="selectedList" class="jobList"></div>
        </div>
      </div>
      <div class="flex">
        <button id="backLevel">◀ Back a level</button>
        <div class="spacer"></div>
        <button id="addToJob">Add to job</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- OPML helpers (with fallbacks) ---------------- */
const FALLBACKS = {
  "./data/opml/core.opml": `<?xml version="1.0" encoding="utf-8"?>
<opml version="1.0"><head><title>Core</title></head><body>
  <outline text="Current boiler (A)">
    <outline text="Regular (1)"/>
    <outline text="System (2)"/>
    <outline text="Combi (3)"/>
  </outline>
  <outline text="Flue (a)">
    <outline text="Horizontal (1)"/>
    <outline text="Vertical (4)">
      <outline text="Pitched roof (1)"/>
      <outline text="Flat roof (2)"/>
    </outline>
  </outline>
</body></opml>`,
  "./data/opml/controls.opml": `<?xml version="1.0" encoding="utf-8"?>
<opml version="1.0"><head><title>Controls</title></head><body>
  <outline text="Controls (C)">
    <outline text="Hive Mini (1)"/>
    <outline text="Hive Multizone (2)"/>
    <outline text="OpenTherm (3)"/>
    <outline text="Weather comp (4)"/>
  </outline>
</body></opml>`,
  "./data/opml/wah.opml": `<?xml version="1.0" encoding="utf-8"?>
<opml version="1.0"><head><title>WAH</title></head><body>
  <outline text="Working at heights">
    <outline text="WAH01 Ladder only"/>
    <outline text="WAH02 Tower scaffold"/>
    <outline text="WAH03 Full scaffold"/>
    <outline text="WAH04 MEWP"/>
  </outline>
</body></opml>`,
  "./data/opml/extras.opml": `<?xml version="1.0" encoding="utf-8"?>
<opml version="1.0"><head><title>Extras</title></head><body>
  <outline text="Extras">
    <outline text="Mag filter (1)"/>
    <outline text="Scale reducer (2)"/>
    <outline text="Condensate upgrade 42mm (3)"/>
    <outline text="Plume kit (4)"/>
  </outline>
</body></opml>`
};

async function fetchText(path){
  try{const r=await fetch(path,{cache:"no-store"});if(!r.ok)throw 0;return await r.text();}
  catch(e){ if(FALLBACKS[path]) return FALLBACKS[path]; throw new Error("Missing "+path); }
}
function parseOPML(xml){
  const dom=new DOMParser().parseFromString(xml,"text/xml");
  const outlines=[...dom.querySelectorAll("body > outline")];
  const toNode = el => ({ text: el.getAttribute("text")||"", children:[...el.children].filter(c=>c.tagName.toLowerCase()==="outline").map(toNode) });
  return outlines.map(toNode);
}

/* ---------------- Tabs ---------------- */
const tabCore=document.getElementById("tab-core");
const tabAdd=document.getElementById("tab-add");
const pageCore=document.getElementById("page-core");
const pageAdd=document.getElementById("page-add");
function selectTab(which){
  const core=which==="core";
  tabCore.setAttribute("aria-selected", core?"true":"false");
  tabAdd.setAttribute("aria-selected", core?"false":"true");
  pageCore.hidden=!core; pageAdd.hidden=core;
}
tabCore.onclick=()=>selectTab("core");
tabAdd.onclick=()=>selectTab("add");

/* ---------------- State ---------------- */
const state = {
  coreBlocks: [], // [{title, roots, path:[], levelNodes:[], done:false}]
  jobItems: [],   // [{id,title,text,qty}]
};
let uid=1;

/* ---------------- Core grove (must complete) ---------------- */
const coreBlocksEl = document.getElementById("coreBlocks");
const coreStatusEl = document.getElementById("coreStatus");

function renderLevel(el, nodes, onPick){
  el.innerHTML="";
  nodes.forEach(n=>{
    const b=document.createElement("button"); b.className="chip"; b.type="button";
    const label=n.text.replace(/\s+\([^)]*\)$/i,"");
    b.textContent=label.trim();
    const code=n.text.match(/\([^)]+\)$/); if(code){const s=document.createElement("small");s.textContent=" "+code[0];b.appendChild(s);}
    b.onclick=()=>onPick(n);
    el.appendChild(b);
  });
}

function makeCrumbs(path){
  const wrap=document.createElement("div"); wrap.className="crumbs";
  path.forEach(n=>{ const c=document.createElement("span");c.className="crumb";c.textContent=n.text;wrap.appendChild(c); });
  return wrap;
}

function renderCoreBlock(block){
  const card=document.createElement("div"); card.className="panel";
  const h=document.createElement("h2"); h.textContent=block.title + (block.done?" ✅":"");
  card.appendChild(h);
  const content=document.createElement("div"); content.className="content grid";
  const strip=document.createElement("div"); strip.className="treeStrip";
  const controls=document.createElement("div"); controls.className="flex";
  const reset=document.createElement("button"); reset.textContent="Reset";
  reset.onclick=()=>{ block.path=[]; block.levelNodes=block.roots; block.done=false; draw(); };
  controls.append(reset);
  content.append(makeCrumbs(block.path));
  content.append(strip);
  content.append(controls);
  card.appendChild(content);
  coreBlocksEl.appendChild(card);

  if(block.done){ strip.innerHTML=`<span class="muted">Done</span>`; }
  else { renderLevel(strip, block.levelNodes, (node)=>{
    block.path.push(node);
    const kids=node.children||[];
    if(kids.length===0){ block.done=true; block.levelNodes=[]; }
    else { block.levelNodes=kids; }
    draw();
  }); }
}

function coreComplete(){
  return state.coreBlocks.every(b=>b.done);
}

function drawCoreStatus(){
  coreStatusEl.textContent= coreComplete() ? "Complete" : "Incomplete";
  coreStatusEl.className = coreComplete() ? "ok" : "bad";
}

function draw(){
  coreBlocksEl.innerHTML="";
  state.coreBlocks.forEach(renderCoreBlock);
  drawCoreStatus();
  recomputeOutputs();
}

document.getElementById("resetCore").onclick=()=>{
  state.coreBlocks.forEach(b=>{b.path=[];b.levelNodes=b.roots;b.done=false;});
  draw();
};

/* ---------------- Add to job (tiles → modal picker) ------------- */
const TILE_MAP = {
  controls: {title:"System controls", path:"./data/opml/controls.opml"},
  wah: {title:"Working at heights", path:"./data/opml/wah.opml"},
  extras: {title:"Extras & misc", path:"./data/opml/extras.opml"}
};
const tilesEl=document.getElementById("tiles");
function drawTiles(){
  tilesEl.innerHTML="";
  Object.entries(TILE_MAP).forEach(([key,meta])=>{
    const t=document.createElement("div"); t.className="tile"; t.tabIndex=0;
    const h=document.createElement("h3"); h.textContent=meta.title;
    const b=document.createElement("span"); b.className="badge"; b.textContent="Open";
    t.append(h,b);
    t.onclick=()=>openPicker(meta);
    tilesEl.appendChild(t);
  });
}

/* ---------------- Picker modal (multi-select within a tree) ----- */
const modal=document.getElementById("pickerModal");
const closePicker=document.getElementById("closePicker");
const pickerTitle=document.getElementById("pickerTitle");
const pickLevel=document.getElementById("pickLevel");
const leafList=document.getElementById("leafList");
const selectedList=document.getElementById("selectedList");
const backLevelBtn=document.getElementById("backLevel");
const addToJobBtn=document.getElementById("addToJob");

let picker = null; // {meta, roots, stack:[nodes], leaves:[nodes], picks: Map(nodeId->{text,qty})}

function nodeIdFor(n){ return (n.__id ??= (Math.random().toString(36).slice(2)+Date.now())); }

function openPicker(meta){
  picker={ meta, roots:[], stack:[], leaves:[], picks:new Map() };
  pickerTitle.textContent = "Select: " + meta.title;
  modal.classList.add("is-open"); modal.setAttribute("aria-hidden","false");
  fetchText(meta.path).then(txt=>{
    picker.roots=parseOPML(txt);
    picker.stack=[picker.roots];
    drawPicker();
  }).catch(err=>{
    leafList.innerHTML=`<div class="help">${err.message}</div>`;
    console.error(err);
  });
}
function closePickerFn(){
  modal.classList.remove("is-open"); modal.setAttribute("aria-hidden","true");
  picker=null;
}
closePicker.onclick=closePickerFn;

function drawPicker(){
  const level = picker.stack[picker.stack.length-1] || [];
  pickLevel.innerHTML="";
  renderLevel(pickLevel, level, (node)=>{
    const kids=node.children||[];
    if(kids.length===0){
      ensureLeaf(node);
    }else{
      picker.stack.push(kids);
      drawPicker();
    }
  });
  refreshLeaves();
  refreshSelected();
}

function ensureLeaf(node){
  if(!picker.leaves.includes(node)) picker.leaves.push(node);
  refreshLeaves();
}

function refreshLeaves(){
  leafList.innerHTML="";
  if(!picker || picker.leaves.length===0){
    const info=document.createElement("div"); info.className="help"; info.textContent="No leaves yet. Tap through levels to reach leaves, then tick them.";
    leafList.appendChild(info);
    return;
  }
  picker.leaves.forEach(n=>{
    const id=nodeIdFor(n);
    const row=document.createElement("label"); row.className="leaf";
    const cb=document.createElement("input"); cb.type="checkbox";
    cb.checked = picker.picks.has(id);
    cb.onchange = ()=>{
      if(cb.checked){ picker.picks.set(id,{ text:n.text, qty:1 }); }
      else { picker.picks.delete(id); }
      refreshSelected();
    };
    const span=document.createElement("span"); span.textContent=n.text;
    row.append(cb, span);
    leafList.appendChild(row);
  });
}

function refreshSelected(){
  selectedList.innerHTML="";
  if(!picker || picker.picks.size===0){ const h=document.createElement("div");h.className="help";h.textContent="Nothing selected yet.";selectedList.appendChild(h);return; }
  picker.picks.forEach((val,key)=>{
    const item=document.createElement("div"); item.className="jobItem";
    const head=document.createElement("div"); head.className="jobHead";
    const title=document.createElement("div"); title.textContent=val.text;
    const qty=document.createElement("input"); qty.className="qty"; qty.type="number"; qty.min="1"; qty.value=val.qty;
    qty.oninput=()=>{ val.qty = Math.max(1, parseInt(qty.value||"1",10)); };
    const rm=document.createElement("button"); rm.textContent="Remove"; rm.onclick=()=>{ picker.picks.delete(key); refreshSelected(); refreshLeaves(); };
    head.append(title, qty, rm);
    item.append(head);
    selectedList.append(item);
  });
}

backLevelBtn.onclick=()=>{
  if(!picker) return;
  if(picker.stack.length>1) picker.stack.pop();
  drawPicker();
};

addToJobBtn.onclick=()=>{
  if(!picker || picker.picks.size===0) return;
  picker.picks.forEach((val)=>{
    state.jobItems.push({ id: "j"+(uid++), title: picker.meta.title, text: val.text, qty: val.qty });
  });
  closePickerFn();
  drawJobList();
  recomputeOutputs();
};

/* ---------------- Job list (on page 2) ---------------- */
const jobListEl=document.getElementById("jobList");
function drawJobList(){
  jobListEl.innerHTML="";
  if(state.jobItems.length===0){
    const h=document.createElement("div");h.className="help";h.textContent="No items yet. Use the tiles above to add.";
    jobListEl.appendChild(h); return;
  }
  state.jobItems.forEach(it=>{
    const card=document.createElement("div"); card.className="jobItem";
    const head=document.createElement("div"); head.className="jobHead";
    const title=document.createElement("div"); title.innerHTML=`<b>${it.title}</b> — ${it.text}`;
    const qty=document.createElement("input"); qty.className="qty"; qty.type="number"; qty.min="1"; qty.value=it.qty;
    qty.oninput=()=>{ it.qty = Math.max(1, parseInt(qty.value||"1",10)); recomputeOutputs(); };
    const del=document.createElement("button"); del.textContent="Delete"; del.onclick=()=>{ state.jobItems = state.jobItems.filter(x=>x.id!==it.id); drawJobList(); recomputeOutputs(); };
    head.append(title, qty, del);
    card.append(head);
    jobListEl.appendChild(card);
  });
}
document.getElementById("clearJob").onclick=()=>{ state.jobItems=[]; drawJobList(); recomputeOutputs(); };

/* ---------------- Outputs (both pages share same data) ---------- */
const outText=document.getElementById("outText");
const outJson=document.getElementById("outJson");
const outText2=document.getElementById("outText2");
const outJson2=document.getElementById("outJson2");
function recomputeOutputs(){
  const core = state.coreBlocks.map(b=>({title:b.title, path:b.path.map(n=>n.text)}));
  const job = state.jobItems.map(j=>({title:j.title, text:j.text, qty:j.qty}));

  const flatCore = core.flatMap(b=> b.path.length? [`${b.title}: ${b.path.map(p=>p.replace(/\s+\(.*?\)$/,'')).join(" > ")}`] : []);
  const flatJob = job.map(j=> `${j.title}: ${j.text} x${j.qty}`);
  const sText = [...flatCore, ...flatJob].join("; ") + (flatCore.length||flatJob.length?";":"");

  const jObj = { core, job };

  const jsonText = JSON.stringify(jObj,null,2);
  outText.value = sText;
  outJson.value = jsonText;
  outText2.value = sText;
  outJson2.value = jsonText;
}
function copySel(id){
  const el=document.getElementById(id);
  el.focus();
  el.select();
  if(typeof document.execCommand === 'function'){
    document.execCommand('copy');
  } else if(navigator.clipboard){
    navigator.clipboard.writeText(el.value);
  }
}
document.getElementById("copyText").onclick=()=>copySel("outText");
document.getElementById("copyJson").onclick=()=>copySel("outJson");
document.getElementById("copyText2").onclick=()=>copySel("outText2");
document.getElementById("copyJson2").onclick=()=>copySel("outJson2");

/* ---------------- Boot: load core OPML and split into blocks ----- */
(async function init(){
  drawTiles();

  try {
    const coreXML = await fetchText("./data/opml/core.opml");
    const roots = parseOPML(coreXML);
    state.coreBlocks = roots.map(r=>({
      title: r.text.replace(/\s+\([^)]+\)$/,""),
      roots: r.children && r.children.length ? r.children : [r],
      path: [],
      levelNodes: r.children && r.children.length ? r.children : [r],
      done:false
    }));
  } catch(err){
    console.error(err);
    state.coreBlocks=[];
  }
  draw();
  drawJobList();
})();
</script>
</body>
</html>
