<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Proposed WPA</title>
<style>
  :root{--bg:#0f1117;--panel:#161a22;--text:#e6e8ee;--muted:#9aa3b2;--accent:#7cd992;--line:#2a3140}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  main{max-width:900px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  textarea{width:100%;min-height:220px;background:#0d0f15;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px}
  .btn{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<main>
  <h1 style="font-size:18px;margin:0 0 10px">Proposed WPA</h1>
  <div class="card">
    <div class="row">
      <button id="btnBuild" class="btn">Build from saved surveys</button>
      <button id="btnCopy" class="btn">Copy</button>
      <span class="muted">Reads selections saved by your trees (gas, wah, misc, systemControls, etc.).</span>
    </div>
    <textarea id="wpaText" placeholder="Your Proposed WPA will appear here..."></textarea>
  </div>
</main>

<!-- ⬇️ Paste the widget script here ⬇️ -->
<script>
(function(){
  // Known tree IDs to scan; add more as you create them
  const TREE_IDS = ['boiler','flue','terminal','cylinderA','cylinderB','controlsA','controlsB','condensateA','condensateB','powerflush','filter','systemControls','gas','wah','misc'];

  // Helper to read localStorage entries
  const selKey = id => `fs:${id}:selections`;
  const fxKey  = id => `fs:${id}:effects`;

  function loadAll(){
    const all = [];
    TREE_IDS.forEach(id=>{
      try{
        const sel = JSON.parse(localStorage.getItem(selKey(id))||'{}');
        const fx  = JSON.parse(localStorage.getItem(fxKey(id))||'{}');
        if (sel && Object.keys(sel).length) all.push({id, sel, fx});
      }catch(e){}
    });
    return all;
  }

  // Optional label maps for a few known steps so WPA reads nicer if IDs are used elsewhere
  const pretty = {
    gas: {
      proposed_input: {
        '12kW':'12 kW', '15kW':'15 kW', '18kW':'18 kW', '24plus':'24 kW+'
      }
    }
  };

  // Core builder: generate one clear proposed paragraph
  function buildWPA(){
    const bundles = loadAll();

    // Extract “proposed” phrases we care about
    const parts = [];

    // Boiler / System Controls (if present)
    const proposedBits = [];
    // we don’t know step IDs for your other trees, so we use effects + flags as hints:
    const notes = [];
    const codes = new Set();
    const flags = new Set();

    bundles.forEach(b=>{
      const fx = b.fx||{};
      (fx.notes||[]).forEach(n=>notes.push(n));
      (fx.codes||[]).forEach(c=>codes.add(c));
      (fx.flags||[]).forEach(f=>flags.add(f));
      // Gas: proposed_input -> friendly
      if (b.id==='gas' && b.sel.proposed_input){
        const v = pretty.gas.proposed_input[b.sel.proposed_input] || b.sel.proposed_input;
        proposedBits.push(`Appliance input approx ${v}`);
      }
      // WAH
      if (b.id==='wah'){
        if (b.sel.scaffold==='scaffold' || (b.fx.flags||[]).includes('wah_scaffold')){
          proposedBits.push(`Scaffold for safe access`);
        } else if ((b.fx.codes||[]).includes('ACC_TOWER')) {
          proposedBits.push(`Access tower/podium as required`);
        } else if ((b.fx.codes||[]).includes('ACC_ROOF_LADDER')) {
          proposedBits.push(`Roof ladder for roof work`);
        }
        if ((b.fx.codes||[]).includes('LAB_TWO_PERSON')){
          proposedBits.push(`Two-person lift`);
        }
      }
      // Misc
      if (b.id==='misc'){
        if ((b.fx.codes||[]).includes('FLT_REPLACE')) proposedBits.push('Replace system filter');
        if ((b.fx.codes||[]).includes('CHEM_INHIB')) proposedBits.push('Dose inhibitor');
        if ((b.fx.codes||[]).includes('SCALE_REDUCER')) proposedBits.push('Fit scale reducer');
        if ((b.fx.codes||[]).includes('COND_WRAP')) proposedBits.push('Insulate external condensate');
      }
      // Gas upsize hints
      if (b.id==='gas'){
        if ((b.fx.codes||[]).includes('GAS_UPSIZE_STD')) proposedBits.push('Upsize gas pipe to maintain permitted pressure drop');
        if ((b.fx.codes||[]).includes('GAS_FLOOR_LIFT')) proposedBits.push('Lift boards for under-floor gas route');
        if ((b.fx.codes||[]).includes('GAS_EXT_REROUTE')) proposedBits.push('External gas re-route (alt path)');
        if ((b.fx.flags||[]).includes('risk_gas_upgrade_tbc')) proposedBits.push('Gas upgrade TBC subject to on-day tests');
      }
    });

    // Compose
    const headline = `Proposed works: ${proposedBits.length ? proposedBits.join('; ') : 'as specified in selections'}.`;
    const codesLine = codes.size ? ` Included items/codes: ${Array.from(codes).join(', ')}.` : '';
    const flagsLine = flags.size ? ` Notes/flags: ${Array.from(flags).join(', ')}.` : '';
    const notesLine = notes.length ? ` Survey notes: ${notes.join(' | ')}.` : '';

    return `${headline}${codesLine}${flagsLine}${notesLine}`;
  }

  // Wire UI
  const out = document.getElementById('wpaText');
  const btnBuild = document.getElementById('btnBuild');
  const btnCopy = document.getElementById('btnCopy');
  btnBuild.onclick = ()=>{ out.value = buildWPA(); out.focus(); out.select(); };
  btnCopy.onclick = ()=>{ out.focus(); out.select(); document.execCommand('copy'); };
})();
</script>
</body>
</html>
